<div
  class="timeline-container mx-auto px-4 py-12"
  style="background-color: var(--bg-color); color: var(--text-color)"
>
  <header class="text-center mb-8">
    <h1 class="text-4xl font-bold text-[var(--text-color)]">Activity Timeline</h1>
    <p class="text-lg text-[var(--text-color)]/70 mt-2">A summary of my work and progress.</p>
  </header>

  <div class="flex justify-center items-center mb-10">
    <div
      class="bg-[var(--card-bg-color)] p-1 rounded-full shadow-md border border-[var(--border-color)] view-mode-toggle"
    >
      <button
        class="view-switch-button px-6 py-2 rounded-full font-medium transition-all duration-300"
        [class.active]="isActiveViewMode('monthly')"
        (click)="setViewMode('monthly')"
        [attr.aria-label]="'Switch to monthly view'"
      >
        Monthly
      </button>
      <button
        class="view-switch-button px-6 py-2 rounded-full font-medium transition-all duration-300"
        [class.active]="isActiveViewMode('annual')"
        (click)="setViewMode('annual')"
        [attr.aria-label]="'Switch to annual view'"
      >
        Annual
      </button>
    </div>
  </div>
  <section class="max-w-5xl mx-auto">
    <ng-container *ngIf="loading(); else timelineContent">
      <div class="flex justify-center py-16">
        <mat-spinner diameter="48"></mat-spinner>
      </div>
    </ng-container>

    <ng-template #timelineContent>
      <ng-container *ngIf="groupedProjects().length; else emptyState">
        <ng-container *ngFor="let group of groupedProjects(); trackBy: trackGroup">
          <h2 class="text-2xl font-bold text-[var(--text-color)] text-center mb-8">
            {{ group.label }}
          </h2>

          <div class="relative wrap overflow-hidden p-10 h-full">
            <div
              class="absolute border-opacity-20 border-[var(--border-color)] h-full border"
              style="left: 50%"
            ></div>

            <ng-container
              *ngFor="let project of group.projects; let idx = index; trackBy: trackByProjectId"
            >
              <div
                class="mb-8 flex justify-between items-start w-full"
                [ngClass]="isLeftAligned(idx) ? 'flex-row-reverse left-timeline' : 'right-timeline'"
              >
                <div class="order-1 w-5/12"></div>
                <div
                  class="z-20 flex items-center order-1 bg-[var(--primary-color)] shadow-xl w-10 h-10 rounded-full"
                >
                  <span class="mx-auto text-white font-semibold">
                    {{ project.startDate | date : 'dd' }}
                  </span>
                </div>
                <div
                  class="order-1 bg-[var(--card-bg-color)] rounded-lg shadow-xl w-5/12 px-6 py-5 border border-[var(--border-color)]"
                >
                  <div class="flex justify-between gap-4 items-start">
                    <div>
                      <h3 class="font-bold text-[var(--text-color)] text-xl">
                        {{ project.title }}
                      </h3>
                      <p class="text-sm text-[var(--text-color)]/70 mt-1">{{ project.company }}</p>
                      <p class="text-xs text-[var(--text-color)]/60 mt-1">
                        {{ project.startDate | date : 'mediumDate' }} -
                        {{ formatProjectDuration(project) }}
                      </p>
                    </div>
                    <span
                      class="text-xs font-semibold px-3 py-1 rounded-full border border-[var(--border-color)] bg-[var(--bg-color)]"
                    >
                      {{ getStatusLabel(project.status) }}
                    </span>
                  </div>

                  <p class="text-sm leading-snug tracking-wide text-[var(--text-color)]/80 mt-3">
                    {{ project.description }}
                  </p>

                  <div *ngIf="project.technologies.length" class="mt-4 flex flex-wrap gap-2">
                    <span
                      *ngFor="let tech of project.technologies"
                      class="text-xs px-3 py-1 rounded-full border border-[var(--border-color)] bg-[var(--bg-color)] text-[var(--text-color)]/80"
                    >
                      {{ tech }}
                    </span>
                  </div>

                  <div *ngIf="project.achievements.length" class="mt-4">
                    <h4 class="text-sm font-semibold text-[var(--text-color)]">Highlights</h4>
                    <ul class="mt-2 space-y-1 text-sm text-[var(--text-color)]/80">
                      <li *ngFor="let achievement of project.achievements">- {{ achievement }}</li>
                    </ul>
                  </div>

                  <div *ngIf="project.challenges.length" class="mt-4">
                    <h4 class="text-sm font-semibold text-[var(--text-color)]">challenges</h4>
                    <ul class="mt-2 space-y-1 text-sm text-[var(--text-color)]/80">
                      <li *ngFor="let challenge of project.challenges">- {{ challenge }}</li>
                    </ul>
                  </div>
                  <div *ngIf="project.images?.length" class="mt-4 flex flex-wrap gap-2">
                    <img
                      alt="{{ project.title }} screenshot {{ idx + 1 }}"
                      class="w-24 h-24 object-cover rounded-md"
                      src="{{ project.images?.[idx] || '' }}"
                    />
                  </div>
                </div>
              </div>
            </ng-container>
          </div>
        </ng-container>
      </ng-container>

      <ng-template #emptyState>
        <div class="text-center py-16 border border-dashed border-[var(--border-color)] rounded-lg">
          <h3 class="text-xl font-semibold text-[var(--text-color)]">No projects to show</h3>
          <p class="text-sm text-[var(--text-color)]/70 mt-3">
            Adjust your filters or search to see more timeline entries.
          </p>
        </div>
      </ng-template>
    </ng-template>
  </section>

  <div class="fixed top-0 right-0 m-4 timeline-button-switch">
    <button
      (click)="toggleTheme()"
      [attr.aria-label]="'Switch to ' + (currentTheme() === 'light' ? 'dark' : 'light') + ' theme'"
    >
      <span class="material-symbols-outlined">
        {{ currentTheme() === 'dark' ? 'light_mode' : 'dark_mode' }}
      </span>
    </button>
  </div>
</div>
